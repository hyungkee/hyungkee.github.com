<!DOCTYPE html>
<html>
<head>
	<title>premium tracker chart</title>
</head>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>

<!-- Load c3.css -->
<link href="chart/c3/c3.min.css" rel="stylesheet">

<!-- Load d3.js and c3.js -->
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="chart/c3/c3.min.js"></script>

<div id="chart"></div>

<script type="text/javascript">
    var myRows = [
    ['x', 'data1', 'data2']
    ]

    var myChart = c3.generate({
        bindto: '#chart',

        data: {
            x: 'x',
            rows: myRows
        },
        axis: {
            x: {
                type: 'timeseries',
                tick: {
                    format: '%Y-%m-%d %H:%M:%S'
                }
            }
        },
        grid: {
            y: {
                show: true
            }
        }
    });

endTime = Math.floor(new Date().getTime() / 1000);
//startTime = endTime - 10 * 60 * 60;
startTime = endTime - 1 * 24 * 60 * 60; // 1 days
unitTime = 60; // 1 minute
lastId = 0;

function appendDataToRows(data, rows){
    var date = data.date;
    var premiumPercent = data.premiumPercent;
    var healthy = data.healthy;
    var id = data.id;

    if(healthy == true){
        var rowDate = new Date(new Date(date).getTime() + 9*1000*60*60); // UTC+9
        var rowData = premiumPercent;
        rows.push([rowDate, rowData]);
    }
}

function loadRows(chart, rows){
    chart.load({
        rows: rows
    })
}

dataURL = 'http://ec2-13-125-16-108.ap-northeast-2.compute.amazonaws.com:8080/premium/between/' + startTime + '/' + endTime + '/unit/' + unitTime;
$.getJSON(dataURL, function(data) {

    for(i=0;i<data.length;i++){
        appendDataToRows(data[i], myRows);
        lastId = data[i].id;
    }

    loadRows(myChart, myRows);
});

setInterval(function(){
    tickURL = 'http://ec2-13-125-16-108.ap-northeast-2.compute.amazonaws.com:8080/premium/after/' + lastId + '/unit/' + unitTime;
    $.getJSON(tickURL, function(data){

        for(i=0;i<data.length;i++){
            appendDataToRows(data[i], myRows);
            lastId = data[i].id;
        }

        loadRows(myChart, myRows);
    })

}, unitTime * 1000);

</script>


<body>
</body>




<!-- <script src="https://d3js.org/d3.v4.min.js"></script>

<script type="text/javascript">
var svgWidth = 200;
var svgHeight = 100;
var svg = d3.select("body").append("svg").attr("width", svgWidth).attr("height", svgHeight);

var dataset = [5, 10, 12, 14, 80];
svg.selectAll('rect')
.data(dataset)
.enter()
.append('rect')
.attr("x", function(data, index){
	return svgWidth * (index / dataset.length)
})
.attr("y", function(data, index){
	return svgHeight - data;
})
.attr("width", svgWidth / dataset.length - 1)
.attr("height", function(data){
	return data;
})
.attr("fill", function(d){
	return "hotpink";
})
</script>

<body>
</body>


</html>